name: FullStack CI CD

on:
  push:
    branches: [main]

jobs:
  # ─────────── CHECK CHANGES ───────────
  changes:
    name: Detect Changes
    runs-on: ubuntu-latest
    outputs:
      client: ${{ steps.filter.outputs.client }}
      admin: ${{ steps.filter.outputs.admin }}
      server: ${{ steps.filter.outputs.server }}

    steps:
      - uses: actions/checkout@v3

      - name: Filter Paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            client:
              - "Frontend/**"
            admin:
              - "Admin/**"
            server:
              - "Backend/**"

  # ─────────── FRONTEND ───────────
  client:
    needs: changes
    if: needs.changes.outputs.client == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./Frontend

    steps:
      - uses: actions/checkout@v3
      - run: npm install
      - run: npm run build

      - name: Netlify Deploy Client
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: Frontend/dist
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Client deployed from GitHub Actions"
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOCKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_CLIENT_SITE_ID }}

  # ─────────── ADMIN ───────────
  admin:
    needs: changes
    if: needs.changes.outputs.admin == 'true'
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: Admin

    steps:
      - uses: actions/checkout@v3

      - name: Setup Node
        uses: actions/setup-node@v3
        with:
          node-version: 22
          cache: "npm"
          cache-dependency-path: Admin/package-lock.json

      - run: npm install
      - run: npm run build

      - name: Deploy Admin to Netlify
        uses: nwtgck/actions-netlify@v2
        with:
          publish-dir: Admin/dist
          production-branch: main
          github-token: ${{ secrets.GITHUB_TOKEN }}
          deploy-message: "Admin deployed from GitHub Actions"
        env:
          NETLIFY_AUTH_TOCKEN: ${{ secrets.NETLIFY_AUTH_TOCKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_ADMIN_SITE_ID }}

  # ─────────── BACKEND ───────────
  server:
    needs: changes
    if: needs.changes.outputs.server == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Notify Railway
        run: echo "Backend changed. Railway GitHub integration will handle deployment."
